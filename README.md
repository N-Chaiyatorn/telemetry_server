# Telemetry API
_Telemetry API_ is responsible for ingesting the telemetry from different kinds of sources and serve the telemetry to the API.

## Features
- Provide realtime telemetry WebSocket API to clients, implemented using [express-ws].
- Provide historical telemetry RESTful API to clients, implemented using [express].
- User defined Deserializer.
- Support logging, need to implement the Database Connector to desired database. Currently, there is only [Cassandra] Connector.
- Scripts and API service to connect with [OpenMCT].
  
## Installation
_Telemetry Server_ requires [Node.js](https://nodejs.org/) v16.13+ to run.

Clone the repository and install the dependencies

```sh
git clone https://github.com/N-Chaiyatorn/telemetry_server.git
cd telemetry_server
npm install
```

## Diagram
![telemetry-api arch](public/telemetry-api.png)

## Usage with OpenMCT
To use this _Telemetry Server_ with NASA's OpenMCT, first you need to clone this [forked version] of the OpenMCT. This version contain four custom plugins which are __*HistoricalTelemetry*__, __*RealtmeTelemetry*__, __*fprimeObject*__ and __*satelliteObject*__.

The __*satelliteObject*__ and __*fprimeObject*__ plugin responsible for populate the telemetry point in OpenMCT and *need metadata file to work*. 

The __*RealtmeTelemetry*__ and __*HistoricalTelemetry*__ plugin responsible for sending the telemetry to the telemetry point generated by __*satelliteObject*__ and __*fprimeObject*__. 

The fprimeObject metadata files is generated from the Fprime Dictionary, which I will explain how to get this file later. You can see example in `src/metadata/raw/RefDictionary.json`. After you get Fprime Dictionary, you can run 

```sh
npm run configure:fprime <Target name>
```

This will generate new metadata files for __*fprimeObject*__ plugin to `src/metadata/openmct/fprimeMetadata/<Target name>/` directory. Then you move these files to `<OpenMCT Root>/src/plugins/fprimeObject/metadata/` in OpenMCT project.

The satelliteObject metadata file is manually create from the user, which need to follow the specified structure. You can see the example in `src/metadata/raw/developmentSatelliteDictionary.json`.

   ```sh
   npm run configure:satellite <Target name>
   ```
This will generate new metadata files for __*satelliteObject*__ plugin to `src/metadata/openmct/<Target name>/` directory. Then you move these files to `<OpenMCT Root>/src/plugins/satelliteObject/metadata/` in OpenMCT project.

## Custom Realtime API Set up
To run this project as your requirements, you need to properly set up as follows
1. Implement your own connecting method in the Extractor class (If exist method is not compatible with your use case).
2. Implement your Deserializer in `/src/Classes/Deserializer/` (If exist Deserializer is not compatible with your use case).
3. Implement your Database Connector in `/src/Classes/DatabaseConnector/` (If exist Deserializer is not compatible with your use case).
4. Implement your express router to response to the request as you want.
5. Create instances of all classes mentioned above and pass the __Extractor__ , __Deserializer__ (if deserialization is needed), and __DatabaseConnector__ (if logging is needed) to the router in `src/server.js`.
6. Start the server.

> Once started, the Extractor will try to connect to the configured endpoint. If success, it will retrives the telemetry and ready to serve to the clients. 

[//]: # (References)
   [node.js]: <http://nodejs.org>
   [express]: <http://expressjs.com>
   [OpenMCT]: <https://github.com/nasa/openmct>
   [Cassandra]: <https://cassandra.apache.org/_/index.html>
   [express-ws]: <https://github.com/HenningM/express-ws>
   [ws]: <https://github.com/websockets/ws>
   [Cassandra-nodejs-driver]: <https://github.com/datastax/nodejs-driver>
   [node-serialport]: <https://github.com/serialport/node-serialport>
   [forked version]: <https://github.com/N-Chaiyatorn/openmct>